generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(uuid()) @db.Uuid
  clerkUserId  String        @unique
  email        String        @unique
  firstName    String?
  lastName     String?
  imageUrl     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  apiKeys      ApiKey[]
  integrations Integration[]
  workflows    Workflow[]

  @@index([clerkUserId])
}

model Workflow {
  id            String      @id @default(cuid())
  name          String
  description   String?
  isActive      Boolean     @default(false)
  triggerType   String?
  triggerConfig Json?
  rfNodes       Json?
  rfEdges       Json?
  lastRunAt     DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  ownerId       String      @db.Uuid
  edges         Edge[]
  executions    Execution[]
  nodes         Node[]
  owner         User        @relation(fields: [ownerId], references: [id])

  @@index([ownerId])
  @@index([isActive])
  @@index([updatedAt])
}

model Node {
  id         String   @id @default(cuid())
  type       String
  data       Json
  positionX  Float
  positionY  Float
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id])
}

model Edge {
  id         String   @id @default(cuid())
  source     String
  target     String
  label      String?
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id])
}

model Integration {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @db.Uuid
  type       String
  name       String
  configEnc  String
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  apiKeys    ApiKey[]
  user       User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
}

model IntegrationType {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique
  displayName  String
  description  String?
  logoUrl      String?
  authType     String
  configSchema Json?
  category     String?
  createdAt    DateTime @default(now())
}

model ApiKey {
  id            String       @id @default(uuid()) @db.Uuid
  userId        String       @db.Uuid
  integrationId String?      @db.Uuid
  name          String
  keyEnc        String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  lastUsedAt    DateTime?
  integration   Integration? @relation(fields: [integrationId], references: [id])
  user          User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([integrationId])
}

model LogEntry {
  id        String   @id @default(cuid())
  level     String
  message   String
  meta      Json?
  createdAt DateTime @default(now())
}

model Execution {
  id          String          @id @default(cuid())
  workflowId  String
  status      String
  triggerType String?
  startedAt   DateTime        @default(now())
  finishedAt  DateTime?
  durationMs  Int?
  successRate Float?
  input       Json?
  output      Json?
  error       Json?
  workflow    Workflow        @relation(fields: [workflowId], references: [id])
  steps       ExecutionStep[]

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
}

model ExecutionStep {
  id          String    @id @default(cuid())
  executionId String
  stepNumber  Int
  nodeId      String
  nodeName    String
  nodeType    String
  status      String
  startedAt   DateTime  @default(now())
  finishedAt  DateTime?
  durationMs  Int?
  input       Json?
  output      Json?
  error       Json?
  execution   Execution @relation(fields: [executionId], references: [id])

  @@index([executionId])
}
